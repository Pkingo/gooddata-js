---
layout: api
title: foobar
---
<div id="doc">
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <div id="api-tabview" class="tabview">
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul class="tabs">
                                <li><a href="#api-modules" class="category">Modules</a>
                                    <ul id="api-modules" class="apis modules">
                                        <li><a href="../modules/admin.html">admin</a></li>
                                        <li><a href="../modules/config.html">config</a></li>
                                        <li><a href="../modules/DataLayer.html">DataLayer</a></li>
                                        <li><a href="../modules/execution.html">execution</a></li>
                                        <li><a href="../modules/metadata.html">metadata</a></li>
                                        <li><a href="../modules/project.html">project</a></li>
                                        <li><a href="../modules/sdk.html">sdk</a></li>
                                        <li><a href="../modules/util.html">util</a></li>
                                        <li><a href="../modules/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                                <li><a href="#api-classes" class="category">Classes</a>
                                    <ul id="api-classes" class="apis classes">
                                        <li><a href="../classes/admin.html">admin</a></li>
                                        <li><a href="../classes/config.html">config</a></li>
                                        <li><a href="../classes/DataLayer.html">DataLayer</a></li>
                                        <li><a href="../classes/execution.html">execution</a></li>
                                        <li><a href="../classes/metadata.html">metadata</a></li>
                                        <li><a href="../classes/project.html">project</a></li>
                                        <li><a href="../classes/sdk.html">sdk</a></li>
                                        <li><a href="../classes/util.html">util</a></li>
                                        <li><a href="../classes/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <strong>gooddata-js</strong> <span class="version">v8.0.0</span>
                        <h1 class="file-heading">File: src/DataLayer/helpers/filters.ts</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        // (C) 2007-2018 GoodData Corporation
                        import cloneDeep = require(&#x27;lodash/cloneDeep&#x27;);
                        import isEmpty = require(&#x27;lodash/isEmpty&#x27;);
                        import { AFM } from &#x27;@gooddata/typings&#x27;;
                        import {
                            unwrapSimpleMeasure,
                            getId,
                            getDateFilterDateDataSet
                        } from &#x27;../utils/AfmUtils&#x27;;
                        
                        function isFilterItem(filter: AFM.CompatibilityFilter): filter is AFM.FilterItem {
                            return !(filter as AFM.IExpressionFilter).value;
                        }
                        
                        function isDateFilter(filter: AFM.CompatibilityFilter): filter is AFM.DateFilterItem {
                            return !!(
                                (filter as AFM.IAbsoluteDateFilter).absoluteDateFilter
                                || (filter as AFM.IRelativeDateFilter).relativeDateFilter
                            );
                        }
                        
                        function getSelection(filter: AFM.CompatibilityFilter): string[] {
                            if ((filter as AFM.IPositiveAttributeFilter).positiveAttributeFilter) {
                                return (filter as AFM.IPositiveAttributeFilter).positiveAttributeFilter.in;
                            }
                            if ((filter as AFM.INegativeAttributeFilter).negativeAttributeFilter) {
                                return (filter as AFM.INegativeAttributeFilter).negativeAttributeFilter.notIn;
                            }
                            return [];
                        }
                        
                        export function isNotEmptyFilter(filter: AFM.CompatibilityFilter): boolean {
                            return isDateFilter(filter) || !isEmpty(getSelection(filter));
                        }
                        
                        export function mergeFilters(afm: AFM.IAfm, filters: AFM.FilterItem[]): AFM.IAfm {
                            const cloned = cloneDeep(afm);
                        
                            return {
                                ...cloned,
                                filters: [...(cloned.filters || []), ...filters]
                                    .filter(isNotEmptyFilter)
                            };
                        }
                        
                        function measureHasDateFilter(simpleMeasure: AFM.ISimpleMeasure) {
                            return (simpleMeasure.filters || []).some(isDateFilter);
                        }
                        
                        function getGlobalDateFilters(afm: AFM.IAfm): AFM.DateFilterItem[] {
                            const ret: AFM.DateFilterItem[] = [];
                            for (const filter of (afm.filters || [])) {
                                if (isFilterItem(filter) &amp;&amp; isDateFilter(filter)) {
                                    ret.push(filter);
                                }
                            }
                            return ret;
                        }
                        
                        /**
                         * AFM Date Filter logic:
                         *
                         * When:
                         *   There is at least one metric with date filter &amp; global date filter present
                         * Then:
                         *   1. To each metric add all global date filters if there isn&#x27;t other date filter with the same date data set
                         *   2. Remove global date filter
                         * Otherwise
                         *   Return provided AFM without any change
                         */
                        
                        export function handleMeasureDateFilter(afm: AFM.IAfm): AFM.IAfm {
                            const globalDateFilters: AFM.DateFilterItem[] = getGlobalDateFilters(afm);
                            if (!globalDateFilters.length) {
                                return afm;
                            }
                        
                            const measureDateFilterIsPresent = (afm.measures || []).some((item: AFM.IMeasure) =&gt; {
                                const simpleMeasure = unwrapSimpleMeasure(item);
                                if (!simpleMeasure) {
                                    return false;
                                }
                                return measureHasDateFilter(simpleMeasure);
                            });
                        
                            if (!measureDateFilterIsPresent) {
                                return afm;
                            }
                        
                            return {
                                ...afm,
                                filters: (afm.filters || []).filter(f =&gt; isFilterItem(f) &amp;&amp; !isDateFilter(f)),
                                measures: (afm.measures || []).map((measure: AFM.IMeasure): AFM.IMeasure =&gt; {
                                    const simpleMeasure = unwrapSimpleMeasure(measure);
                                    if (simpleMeasure) {
                                        const simpleMeasureFilters = simpleMeasure.filters || [];
                                        return {
                                            ...measure,
                                            definition: {
                                                measure: {
                                                    ...simpleMeasure,
                                                    filters: joinGlobalAndMeasureFilters(simpleMeasureFilters, globalDateFilters)
                                                }
                                            }
                                        };
                                    }
                        
                                    return measure;
                                })
                            };
                        }
                        
                        function joinGlobalAndMeasureFilters(
                            measureFilters: AFM.FilterItem[], globalDateFilters: AFM.DateFilterItem[]
                        ): AFM.FilterItem[] {
                            const measureDateFilters: AFM.DateFilterItem[] = measureFilters.filter(isDateFilter);
                            const globalDateFiltersToAdd = globalDateFilters.filter((globalDateFilter: AFM.DateFilterItem) =&gt; {
                                const dateDataSetPresent = !measureDateFilters.some((measureDateFilter: AFM.DateFilterItem) =&gt; {
                                    const globalFilterDataSet = getDateFilterDateDataSet(globalDateFilter);
                                    const measureFilterDataSet = getDateFilterDateDataSet(measureDateFilter);
                                    return getId(globalFilterDataSet) === getId(measureFilterDataSet);
                                });
                                return dateDataSetPresent;
                            });
                        
                            return [...measureFilters, ...globalDateFiltersToAdd];
                        }
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

